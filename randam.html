<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è’é‡è¡Œå‹• ç¸›ã‚Šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</title>
<style>
html, body {height:100%; margin:0; font-family:Arial,sans-serif; background:#f2f2f2;}
#setup, #roulette, #allResults {display:none; flex-direction:column; justify-content:center; align-items:center; height:100vh;}
#result {font-size:6vw; text-align:center; padding:20px; background:#fff; border-radius:10px; margin-bottom:20px; box-shadow:0 4px 8px rgba(0,0,0,0.15);}
button {font-size:18px; padding:12px 25px; margin:10px; cursor:pointer; border:none; border-radius:6px; background:#4CAF50; color:white;}
button:hover {background:#45a049;}
input {font-size:18px; margin:5px; padding:8px;}
#currentPlayer {font-size:2em; color:#222; margin:10px 0 5px 0; text-align:center;}
#matchInfo {font-size:1.5em; color:#555; margin-bottom:15px; text-align:center;}
.resultBox {background:#fff; border-radius:8px; padding:10px; margin:5px; width:80%; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.resultBox h3 {margin:0 0 5px 0;}
#backBtn {background:#f44336;}
#backBtn:hover {background:#d32f2f;}
</style>
</head>
<body>

<div id="setup">
  <h2>ğŸ® äººæ•°ã‚’å…¥åŠ›ï¼ˆæœ€å¤§5äººï¼‰</h2>
  <input type="number" id="playerCount" min="1" max="5" placeholder="äººæ•°ã‚’å…¥åŠ› (1ã€œ5)">
  <button id="setPlayers">æ¬¡ã¸ â¡</button>
  <div id="nameInputs"></div>
  <button id="startBtn" style="display:none;">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã¸é€²ã‚€</button>
</div>

<div id="roulette">
  <h1>ğŸ¯ è’é‡è¡Œå‹• ç¸›ã‚Šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h1>
  <h2 id="currentPlayer"></h2>
  <div id="matchInfo"></div>
  <div id="result">çµæœè¡¨ç¤ºã¯ã“ã“</div>
  <button id="shuffleBtn">ç¸›ã‚Šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ ğŸ²</button>
  <button id="nextPlayerBtn" style="display:none;">æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ â¡</button>
  <button id="nextMatchBtn" style="display:none;">æ¬¡ã®è©¦åˆã¸ ğŸ</button>
  <button id="viewResultBtn">çµæœä¸€è¦§ã‚’è¦‹ã‚‹ ğŸ“‹</button>
  <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ ğŸ”</button>
</div>

<div id="allResults">
  <h1>ğŸ“‹ å…¨è©¦åˆçµæœ</h1>
  <div id="resultsContainer" style="width:90%; max-height:80vh; overflow-y:auto;"></div>
  <button id="backBtn">Ã— æˆ»ã‚‹</button>
</div>

<script>
const weapons = [
 "95å¼","G36C","AR18","M4A1","M4A4","SCAR-L","AK-47","SCAR-H","M16A4","AUG","RN94","AK14","M27","81å¼","HK50","AKAIpha","MC-X","ADS","APS",
 "Dual TMP","UZI","MK5","MP5","PP2000","05å¼","ãƒˆãƒ³ãƒ—ã‚½ãƒ³","P90",
 "LSR-8","AWM","CS","AMR-83","Kar98k","M24","ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ","M1891","çˆ†è£‚å¼“","SVD","Val","88å¼","56å¼","ã‚¯ãƒ­ã‚¹ãƒœã‚¦",
 "M860","M88C","SK12",
 "ã‚¬ãƒˆãƒªãƒ³ã‚°ã‚¬ãƒ³","MK60","95å¼è»½æ©Ÿé–¢éŠƒ"
];

let players = [];
let currentIndex = 0;
let matchCount = parseInt(localStorage.getItem("matchCount") || "1");
let results = JSON.parse(localStorage.getItem("rouletteResults") || "{}");
let currentMatchResults = {}; // ä»Šã®è©¦åˆã§ã®å›æ•°ç®¡ç†

const setupDiv = document.getElementById("setup");
const rouletteDiv = document.getElementById("roulette");
const allResultsDiv = document.getElementById("allResults");
const resultDiv = document.getElementById("result");
const currentPlayerEl = document.getElementById("currentPlayer");
const matchInfoEl = document.getElementById("matchInfo");
const resultsContainer = document.getElementById("resultsContainer");

// äººæ•°å…¥åŠ›
document.getElementById("setPlayers").addEventListener("click", ()=>{
  const count = parseInt(document.getElementById("playerCount").value);
  const nameInputs = document.getElementById("nameInputs");
  nameInputs.innerHTML="";
  if(count>=1 && count<=5){
    for(let i=0;i<count;i++){
      const input=document.createElement("input");
      input.type="text";
      input.placeholder=`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}ã®åå‰`;
      nameInputs.appendChild(input);
    }
    document.getElementById("startBtn").style.display="block";
  }
});

// åå‰å…¥åŠ› â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆç”»é¢
document.getElementById("startBtn").addEventListener("click", ()=>{
  const inputs = document.querySelectorAll("#nameInputs input");
  players = Array.from(inputs).map(i=>i.value.trim()).filter(n=>n!=="");
  if(players.length===0) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
  setupDiv.style.display="none";
  rouletteDiv.style.display="flex";
  currentIndex=0;
  currentMatchResults={};
  showPlayer();
});

// ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º
function showPlayer(){
  if(currentIndex<players.length){
    const name=players[currentIndex];
    currentPlayerEl.innerHTML=`ğŸ® ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼š<strong>${name}</strong>`;
    matchInfoEl.innerHTML=`ğŸ† ç¬¬${matchCount}è©¦åˆ`;
    resultDiv.innerHTML="çµæœè¡¨ç¤ºã¯ã“ã“";
    document.getElementById("nextPlayerBtn").style.display="none";
    document.getElementById("nextMatchBtn").style.display="none";
  }else{
    document.getElementById("nextPlayerBtn").style.display="none";
    document.getElementById("nextMatchBtn").style.display="block";
  }
}

// ãƒ©ãƒ³ãƒ€ãƒ å–å¾—
function pickUniqueRandom(arr,count){
  const n=Math.min(count,arr.length);
  const copy=arr.slice();
  const picked=[];
  for(let i=0;i<n;i++){
    const idx=Math.floor(Math.random()*copy.length);
    picked.push(copy.splice(idx,1)[0]);
  }
  return picked;
}

// ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ
function startRoulette(){
  const name = players[currentIndex];
  if(!currentMatchResults[name]) currentMatchResults[name]=0;
  currentMatchResults[name]++;
  const isPunishment = currentMatchResults[name]>1; // 2å›ç›®ä»¥é™

  let pickCount = Math.random()<0.5?1:2;
  let finalPicked = pickUniqueRandom(weapons, pickCount);

  if(isPunishment){
    const punishmentText = prompt("ç½°ã‚²ãƒ¼ãƒ ã¯ï¼Ÿ", "ç½°ã‚²ãƒ¼ãƒ å†…å®¹");
    if(punishmentText){
      finalPicked[0] = `${finalPicked[0]} (ç½°ã‚²ãƒ¼ãƒ ï¼š${punishmentText})`;
    }
  }

  let count=0;
  const steps=60;
  const interval = setInterval(()=>{
    const random1 = weapons[Math.floor(Math.random()*weapons.length)];
    const random2 = weapons[Math.floor(Math.random()*weapons.length)];
    resultDiv.innerHTML = `${name} ã®ç¸›ã‚Šä¸­...<br>${random1}<br>${random2}`;
    count++;
    if(count>=steps){
      clearInterval(interval);
      // çµæœè¡¨ç¤º
      resultDiv.innerHTML = `${name} ã®ç¸›ã‚Šçµæœ<br>1. ${finalPicked[0]}<br>2. ${finalPicked[1]||"è‡ªç”±ãªæ­¦å™¨"}`;

      // ä¿å­˜ï¼ˆ1. 2. ã®æ­¦å™¨åã§ä¿å­˜ï¼‰
      const matchKey = `è©¦åˆ${matchCount}_${name}`;
      results[matchKey] = {
        title: `ç¬¬${matchCount}è©¦åˆ`,
        name,
        shibari: [`1. ${finalPicked[0]}`, `2. ${finalPicked[1]||"è‡ªç”±ãªæ­¦å™¨"}`]
      };
      localStorage.setItem("rouletteResults", JSON.stringify(results));

      document.getElementById("nextPlayerBtn").style.display="block";
    }
  },50);
}


// ãƒœã‚¿ãƒ³
document.getElementById("shuffleBtn").addEventListener("click", startRoulette);
document.getElementById("nextPlayerBtn").addEventListener("click", ()=>{
  currentIndex++;
  showPlayer();
});
document.getElementById("nextMatchBtn").addEventListener("click", ()=>{
  matchCount++;
  localStorage.setItem("matchCount", matchCount);
  currentIndex=0;
  currentMatchResults={};
  showPlayer();
});
document.getElementById("viewResultBtn").addEventListener("click", ()=>{
  // å…¨è©¦åˆè¡¨ç¤º
  rouletteDiv.style.display="none";
  allResultsDiv.style.display="flex";
  resultsContainer.innerHTML="";
  const grouped = {};
  Object.values(results).forEach(r=>{
    if(!grouped[r.title]) grouped[r.title]=[];
    grouped[r.title].push(r);
  });
  for(const match in grouped){
    const box = document.createElement("div");
    box.className="resultBox";
    let html = `<h3>ğŸ† ${match}</h3>`;
    grouped[match].forEach(r=>{
      html += `ğŸ‘¤ ${r.name} ğŸ”« ${r.shibari.join(", ")}<br>`;
    });
    box.innerHTML=html;
    resultsContainer.appendChild(box);
  }
});

document.getElementById("backBtn").addEventListener("click", ()=>{
  allResultsDiv.style.display="none";
  rouletteDiv.style.display="flex";
});

document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒå…¨ã¦æ¶ˆãˆã¾ã™ã€‚")){
    localStorage.removeItem("rouletteResults");
    localStorage.removeItem("matchCount");
    results={};
    matchCount=1;
    location.reload();
  }
});
  
// åˆæœŸè¡¨ç¤º
window.onload = () => {
  const storedResults = localStorage.getItem("rouletteResults");
  const storedMatchCount = localStorage.getItem("matchCount");

  if(storedResults || storedMatchCount){
    // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
    if(confirm("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã™ã€‚ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ\n\nã¯ã„: æ¶ˆã—ã¦ãƒªã‚»ãƒƒãƒˆ\nã„ã„ãˆ: ç¶šãã‹ã‚‰")){
      // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
      localStorage.removeItem("rouletteResults");
      localStorage.removeItem("matchCount");
      results = {};
      matchCount = 1;
      players = [];
      setupDiv.style.display = "flex";
      rouletteDiv.style.display = "none";
      allResultsDiv.style.display = "none";
    } else {
      // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      results = JSON.parse(storedResults || "{}");
      matchCount = parseInt(storedMatchCount || "1");

      // å‰å›ã®è©¦åˆã«å‚åŠ ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å–å¾—
      players = Object.values(results)
                      .filter(r => r.title === `ç¬¬${matchCount}è©¦åˆ`)
                      .map(r => r.name);

      if(players.length > 0){
        setupDiv.style.display = "none";
        rouletteDiv.style.display = "flex";
        currentIndex = 0;
        currentMatchResults = {};
        showPlayer();
      } else {
        setupDiv.style.display = "flex";
      }
    }
  } else {
    // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯é€šå¸¸ã®åˆæœŸç”»é¢
    setupDiv.style.display = "flex";
  }
};
</script>
</body>
</html>


